name: Build and Deploy (production)

on:
    release:
        branches: [ main ]
        types: [ released, deleted ]

jobs:
    checkout:
        runs-on: [self-hosted, linux, X64]
        steps:
            - name: Get latest released version
              id: lastver
              uses: pozetroninc/github-action-get-latest-release@v0.5.0
              with:
                  repository: ${{ github.repository }}
                  excludes: prerelease, draft
            - name: Checkout latest tag
              uses: actions/checkout@v2
              with:
                  ref: ${{ steps.lastver.outputs.release }}
                  path: prod

    deploy:
        needs: checkout
        runs-on: [self-hosted, linux, X64]
        env:
            NEXT_PUBLIC_YM_ID: ${{ secrets.YM_ID }}
            NEXT_PUBLIC_GA_ID: ${{ secrets.GA_ID }}
            GENERATE_SOURCEMAP: false
        steps:
            - name: Set production API
              working-directory: prod/src/API
              run: |
                  python3 -c "with open('http.js', 'r+') as f:
                      d = f.read()
                      d = d.replace('https://api.cyberdas.net/next', 'https://api.cyberdas.net/v1')
                      f.seek(0)
                      f.write(d)
                      f.truncate()
                      f.close()"
            - name: Create dotenv file
              uses: iamsauravsharma/create-dotenv@v1.2.0
              with:
                  directory: 'prod/'
            - name: Build container
              working-directory: prod
              run: |
                  docker-compose -f docker-compose.yml -f docker-compose.production.yml build web
            - name: Deploy container
              working-directory: prod
              run: |
                  docker-compose -f docker-compose.yml -f docker-compose.production.yml up --no-deps -d web

    healthcheck:
        needs: deploy
        runs-on: [self-hosted, linux, X64]
        steps:
            - name: Get container id
              working-directory: prod
              id: contid 
              run: |
                  docker-compose -f docker-compose.yml -f docker-compose.production.yml ps -q
            - name: Check container status
              id: contstatus
              run: |
                  docker container inspect -f '{{.State.Status}}' ${{ steps.contid.outputs }}
            - name: Exit on error
              if: steps.contstatus.outputs != 'running'
              run: exit 1